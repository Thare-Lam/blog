<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Thare</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://thare.cn/"/>
  <updated>2019-03-22T14:10:28.909Z</updated>
  <id>https://thare.cn/</id>
  
  <author>
    <name>Thare_Lam</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Elasticsearch DSL快速上手指南</title>
    <link href="https://thare.cn/posts/41633c75.html"/>
    <id>https://thare.cn/posts/41633c75.html</id>
    <published>2019-03-22T14:07:47.000Z</published>
    <updated>2019-03-22T14:10:28.909Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 22 2019 22:10:32 GMT+0800 (China Standard Time) --><p>本文整理常用的Elasticsearch dsl，旨在帮助初学者能够快速构造dsl。如果想精通，还是阅读<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html" rel="external nofollow noopener noreferrer" target="_blank">官方文档</a>为佳。</p><h2 id="如何搜索"><a href="#如何搜索" class="headerlink" title="如何搜索"></a>如何搜索</h2><p>向ES发送rest请求即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> curl -XPOST http://ip:port?indexName/_search -d "json格式的dsl"</span><br></pre></td></tr></table></figure><h2 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h2><p>先介绍几种复合查询类型（需要包在bool中使用，详情看下方例子） <a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-bool-query.html" rel="external nofollow noopener noreferrer" target="_blank">官网传送门</a></p><table><thead><tr><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>must</td><td>必须满足。包含在must内的条件都必须要满足，且会影响最后搜索得分。</td></tr><tr><td>must_not</td><td>必须不满足。包含在must_not内的条件都不应该满足，不会影响最后搜索得分。</td></tr><tr><td>filter</td><td>过滤。和must很像，但有两个区别<br>1. 不会影响搜索得分，速度较must更快<br>2.在ES内会有缓存，加快下次同样条件的查询</td></tr><tr><td>should</td><td>在should内的条件之间是或关系。</td></tr></tbody></table><p>再介绍几种常用的搜索类型 <a href="https://kapeli.com/dash_share?docset_file=ElasticSearch&amp;docset_name=ElasticSearch&amp;path=www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html&amp;platform=elasticsearch&amp;repo=Main&amp;source=www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html&amp;version=6.6.2" rel="external nofollow noopener noreferrer" target="_blank">官网传送门</a></p><table><thead><tr><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>term</td><td>类似sql中的=</td></tr><tr><td>terms</td><td>类似sql中的in</td></tr><tr><td>match</td><td>分词匹配，一般嵌套在must内使用。<br>字段类型为text</td></tr><tr><td>match_phrase</td><td>短语匹配，一般嵌套在must内使用。</td></tr><tr><td>range</td><td>范围匹配</td></tr><tr><td>exists</td><td>存在</td></tr><tr><td>wildcard</td><td>模糊查询（禁止在程序中使用）</td></tr></tbody></table><p>下面通过一段dsl来理解</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"match"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"手机"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"must_not"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"term"</span>: &#123;</span><br><span class="line">            <span class="attr">"status"</span>: <span class="number">-3</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"term"</span>: &#123;</span><br><span class="line">            <span class="attr">"level"</span>: <span class="number">1</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"filter"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"range"</span>: &#123;</span><br><span class="line">            <span class="attr">"price"</span>: &#123;</span><br><span class="line">              "from": 100, //下边界为100</span><br><span class="line">              "to": null, // 无上边界</span><br><span class="line">              "include_lower": true, // 包含下边界</span><br><span class="line">              "include_upper": false // 包含上边界</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      "should": [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"term"</span>: &#123;</span><br><span class="line">            <span class="attr">"brandId"</span>: <span class="number">1</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"term"</span>: &#123;</span><br><span class="line">            <span class="attr">"brandId"</span>: <span class="number">2</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段dsl的含义是</p><ol><li><p>name能匹配上”手机”</p></li><li><p>status不为-3且level不为1</p></li><li><p>价格大于等于100</p></li><li><p>brandId没有限制。很奇怪对不对？看看官方解释</p><blockquote><p>If the <code>bool</code> query is in a <a href="query-filter-context.html">query context</a> and has a <code>must</code> or <code>filter</code> clause then a document will match the <code>bool</code> query even if none of the <code>should</code> queries match. In this case these clauses are only used to influence the score.</p></blockquote><p>意思是：如果一个should同时和must或filter存在同一级，则搜索出来的文档可以不满足should中的条件，should中的条件仅仅会影响搜索得分。</p><p>因此，在这种情况下，<strong>brandId为1或2的结果搜索得分会更高</strong>。</p><p>如果想达到<strong>或</strong>关系要怎么做呢？有两种办法：</p><ol><li><p>同级查询类型中没有must或filter</p></li><li><p>将should包在filter内，例</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  "filter":[</span><br><span class="line">    &#123;</span><br><span class="line">      "bool":&#123; // 记得包在bool中</span><br><span class="line">        "should":[</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"term"</span>: &#123;</span><br><span class="line">              <span class="attr">"brandId"</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"term"</span>: &#123;</span><br><span class="line">              <span class="attr">"brandId"</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li></ol><h2 id="搜索属性"><a href="#搜索属性" class="headerlink" title="搜索属性"></a>搜索属性</h2><p>几种常用搜索属性 <a href="https://kapeli.com/dash_share?docset_file=ElasticSearch&amp;docset_name=ElasticSearch&amp;path=www.elastic.co/guide/en/elasticsearch/reference/current/search-request-body.html&amp;platform=elasticsearch&amp;repo=Main&amp;source=www.elastic.co/guide/en/elasticsearch/reference/current/search-request-body.html&amp;version=6.6.2" rel="external nofollow noopener noreferrer" target="_blank">官网传送门</a></p><table><thead><tr><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>from</td><td>从第几条结果开始</td></tr><tr><td>size</td><td>返回多少条结果</td></tr><tr><td>_source</td><td>控制返回的字段</td></tr><tr><td>sort</td><td>排序方式，默认按搜索得分倒序排序</td></tr></tbody></table><p>看个例子</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"from"</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">20</span>,</span><br><span class="line">  <span class="attr">"_source"</span>: [<span class="string">"id"</span>, <span class="string">"name"</span>],</span><br><span class="line">  <span class="attr">"sort"</span>:[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"updatedAt"</span>: &#123;</span><br><span class="line">        <span class="attr">"order"</span>: <span class="string">"desc"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"id"</span>: &#123;</span><br><span class="line">        <span class="attr">"order"</span>: <span class="string">"asc"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>表示</p><ol><li>从第10条记录开始，返回20条记录</li><li>只返回id和name两个字段</li><li>先按更新时间倒序，再按id升序排序</li></ol><h2 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h2><p>几种常用聚合类型 <a href="https://kapeli.com/dash_share?docset_file=ElasticSearch&amp;docset_name=ElasticSearch&amp;path=www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html&amp;platform=elasticsearch&amp;repo=Main&amp;source=www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html&amp;version=6.6.2" rel="external nofollow noopener noreferrer" target="_blank">官网传送门</a></p><table><thead><tr><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>terms</td><td>类似group by</td></tr><tr><td>cardinality</td><td>类似count(distinct)</td></tr><tr><td>extended_stats</td><td>计算count、sum、min、max等</td></tr></tbody></table><p>看个例子</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "aggs":&#123; //也可写为aggregations</span><br><span class="line">    "agg1":&#123;</span><br><span class="line">      "terms":&#123;</span><br><span class="line">        "field": "shopId"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "agg2":&#123;</span><br><span class="line">      "cardinality":&#123;</span><br><span class="line">        "field": "status"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "agg3":&#123;</span><br><span class="line">      "extended_stats":&#123;</span><br><span class="line">        "field": "price"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这些聚合的含义是</p><ol><li>agg1：对shopId做group by</li><li>agg2：统计共有多少种status</li><li>agg3：查看价格的多种统计结果</li></ol><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>看个比较完整的dsl</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"from"</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">20</span>,</span><br><span class="line">  <span class="attr">"_source"</span>: [</span><br><span class="line">    <span class="string">"id"</span>,</span><br><span class="line">    <span class="string">"name"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"sort"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"updatedAt"</span>: &#123;</span><br><span class="line">        <span class="attr">"order"</span>: <span class="string">"desc"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"id"</span>: &#123;</span><br><span class="line">        <span class="attr">"order"</span>: <span class="string">"asc"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"match"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"手机"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"must_not"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"term"</span>: &#123;</span><br><span class="line">            <span class="attr">"status"</span>: <span class="number">-3</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"term"</span>: &#123;</span><br><span class="line">            <span class="attr">"level"</span>: <span class="number">1</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"filter"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"range"</span>: &#123;</span><br><span class="line">            <span class="attr">"price"</span>: &#123;</span><br><span class="line">              <span class="attr">"from"</span>: <span class="number">100</span>,</span><br><span class="line">              <span class="attr">"to"</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">"include_lower"</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">"include_upper"</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"should"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"term"</span>: &#123;</span><br><span class="line">            <span class="attr">"brandId"</span>: <span class="number">1</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"term"</span>: &#123;</span><br><span class="line">            <span class="attr">"brandId"</span>: <span class="number">2</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"agg1"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"shopId"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"agg2"</span>: &#123;</span><br><span class="line">      <span class="attr">"cardinality"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"status"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"agg3"</span>: &#123;</span><br><span class="line">      <span class="attr">"extended_stats"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"price"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Fri Mar 22 2019 22:10:32 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;本文整理常用的Elasticsearch dsl，旨在帮助初学者能够快速构造dsl。如果想精通，还是阅读&lt;a href=&quot;h
      
    
    </summary>
    
      <category term="Elasticsearch" scheme="https://thare.cn/categories/Elasticsearch/"/>
    
    
      <category term="Elasticsearch" scheme="https://thare.cn/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>使用Elasticsearch Scroll实现索引迁移工具</title>
    <link href="https://thare.cn/posts/21fbc3c7.html"/>
    <id>https://thare.cn/posts/21fbc3c7.html</id>
    <published>2018-10-11T08:22:43.000Z</published>
    <updated>2019-03-22T14:10:12.223Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 22 2019 22:10:29 GMT+0800 (China Standard Time) --><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近需要在预发环境测试分词词库，但苦于没有预发环境机器的权限，不能随时改es的配置，也不想麻烦运维。虽然有开发环境的机器权限，但开发环境的索引数据量少，且数据不够优雅，不能很好地反映实际使用效果。所以，需要把预发环境的索引同步到开发环境。安全原因，开发环境和预发环境网络是隔离的，只能通过本地起服务来同步。</p><p>环境信息：</p><ul><li>索引量：100w</li><li>索引大小：1.5G</li><li>ES版本：6.2.3</li></ul><h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p>首先考虑的是使用es的scroll API来获取全部数据，<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-scroll.html" rel="external nofollow noopener noreferrer" target="_blank">官方文档</a>是这样介绍的：</p><blockquote><p>While a <code>search</code> request returns a single “page” of results, the <code>scroll</code> API can be used to retrieve large numbers of results (or even all results) from a single search request, in much the same way as you would use a cursor on a traditional database.</p><p>Scrolling is not intended for real time user requests, but rather for processing large amounts of data, e.g. in order to reindex the contents of one index into a new index with a different configuration.</p></blockquote><p>即scroll可以获取大量结果（search的窗口大小只有10000），甚至是全部。但它不是为了实时请求（准实时）而生，而是为了处理大量的数据，例如为了修改索引配置而重建索引。所以这里使用scroll来迁移索引是再合适不过了。</p><p><strong><em>注意：scroll获取的数据是第一个scroll请求发起时的快照，从那刻以后索引发生的变更都不会影响scroll的结果。也就是说，如果整个scroll过程有1个小时，那么最后获取到的数据是1个小时前的快照。所以，对于有实时性要求的场景需要考虑通过其它手段来保证数据一致性。</em></strong></p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>先看看如何使用scroll。</p><p>首先需要先发一个search请求，并指定scroll值（下面会讲）和其他搜索参数（如size、query等，只需第一次指定，后续请求都会沿用）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /item/_search?scroll=10s</span><br><span class="line">&#123;</span><br><span class="line">    "size": 500,</span><br><span class="line">    "query": &#123;</span><br><span class="line">        "term" : &#123;</span><br><span class="line">            "status" : "1"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个请求除了返回基本的搜索结果外，还会有一个<code>_scroll_id</code></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"_scroll_id"</span>: <span class="string">"DnF1ZXJ5VGhlbkZldGNoldG56LVJrdUtOVGtHQU1h"</span>,</span><br><span class="line">    <span class="attr">"took"</span>: <span class="number">5</span>,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个<code>_scroll_id</code>需要传入下次scroll请求中（类似游标），同时也需要指定scroll的值</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST  /_search/scroll </span><br><span class="line">&#123;</span><br><span class="line">    "scroll" : "10s", </span><br><span class="line">    "scroll_id" : "JLSGPOTWNTLKNG3SAGLKGKLJ8ASGLKMKSAGLSAMGSNA13KMFGKLNLKASNGCDSD==" </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如此不断请求，直到返回的hits为空，就取到了满足搜索条件的所有数据了。</p><p><strong><em>注意：后续scroll请求不需要指定index。</em></strong></p><p>那么这个scroll参数是什么意思呢？<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-scroll.html#scroll-search-context" rel="external nofollow noopener noreferrer" target="_blank">官方文档</a>如下</p><blockquote><p>The <code>scroll</code> parameter (passed to the <code>search</code> request and to every <code>scroll</code> request) tells Elasticsearch how long it should keep the search context alive. Its value (e.g. <code>1m</code>, see <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/common-options.html#time-units" rel="external nofollow noopener noreferrer" target="_blank">Time units</a>) does not need to be long enough to process all data — it just needs to be long enough to process the previous batch of results. Each <code>scroll</code> request (with the <code>scroll</code> parameter) sets a new expiry time.</p></blockquote><p>scroll参数用来告诉es需要将搜索上下文保持多久，这个时间<strong>不需要</strong>是你处理全部数据的时间，能保证处理完一批数据就行。例如，某次请求拿到了一批数据，只要在这段时间内处理完这批数据并能发起下一个请求就可以了。</p><p><strong><em>注意：scroll值不是越大越好。因为通常情况下，小的segment会合并成大的segment，同时小的segment会被删除。但在scroll的搜索上下文保持时间段内，小的segment不会被删除，而是被用来返回第一个搜索请求时刻的快照，这样会消耗更多的文件句柄。所以把scroll值设置成稍微比处理数据的时间多几秒就好。</em></strong></p><p>当然，如果不同批次的数据处理没有依赖关系的话，也可以通过多线程来处理数据，这样scroll参数可以设置小一点。</p><p>如果使用过期的_scroll_id将会得到如下报错</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"type"</span>: <span class="string">"search_context_missing_exception"</span>,</span><br><span class="line"><span class="attr">"reason"</span>: <span class="string">"No search context found for id [xxx]"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在scroll请求完后也可以手动清除搜索上下文</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DELETE /_search/scroll</span><br><span class="line">&#123;</span><br><span class="line">    "scroll_id" : [</span><br><span class="line">      "DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAD4WYm9laVYtZndUQlNsdDcwakFMNjU1QQ==",</span><br><span class="line">      "AAAAAAAFFmtSWWRRWUJrU2o2ZExpSGJCVmQAABBZrUllkUVlCa1NqNmRMaUhiQlZkMWFB"</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>清除所有<br></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /_search/scroll/_all</span><br></pre></td></tr></table></figure><p></p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>scroll会用了，那下面就来实现吧。</p><p>基本流程：</p><ol><li>获取需要迁移的索引mapping</li><li>在新的es集群创建索引并设置mapping</li><li>通过scroll不断获取数据并写入新索引，直到scroll获取的数据为空</li></ol><h2 id="项目"><a href="#项目" class="headerlink" title="项目"></a>项目</h2><p><a href="https://github.com/Thare-Lam/elasticsearch-migration" rel="external nofollow noopener noreferrer" target="_blank">elasticsearch-migration</a></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Fri Mar 22 2019 22:10:29 GMT+0800 (China Standard Time) --&gt;&lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h
      
    
    </summary>
    
      <category term="Elasticsearch" scheme="https://thare.cn/categories/Elasticsearch/"/>
    
    
      <category term="Elasticsearch" scheme="https://thare.cn/tags/Elasticsearch/"/>
    
      <category term="索引迁移" scheme="https://thare.cn/tags/%E7%B4%A2%E5%BC%95%E8%BF%81%E7%A7%BB/"/>
    
  </entry>
  
  <entry>
    <title>ElasticSearch性能调优之设置refresh_interval实战</title>
    <link href="https://thare.cn/posts/c358565.html"/>
    <id>https://thare.cn/posts/c358565.html</id>
    <published>2018-09-28T07:36:51.000Z</published>
    <updated>2019-03-22T14:09:59.217Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 22 2019 22:10:29 GMT+0800 (China Standard Time) --><blockquote><p>接手搜索几个月了，把公司的商品搜索从业务代码剥离成独立应用，再不断调整优化（代码结构），目前暂时趋于稳定（搜索中心化和产品化还有很长一段路要走），也能够迅速响应上层业务方的需求。自己也由一个搜索小白到了小试牛刀的阶段。项目中也还有很多可以改进的地方，自己对ES的深度和广度也有待加强。</p></blockquote><p>先贴上环境信息</p><ul><li>业务背景：商品</li><li>ES版本：6.2.3</li><li>集群配置：5台8核32G SSD</li><li>系统信息：CentOS 7.2 64位</li><li>索引信息：1100w个doc，5个分片，1个副本，约20G（不含副本）</li></ul><p>搜索应用的rt表现如下（qps约20）</p><p><img src="https://coding.net/u/Thare-Lam/p/blog/git/raw/master/asserts/img/0x02/before.jpg" alt="before"></p><p>可以看到，请求主要分布在400ms以内，且有一条明显的100ms分界线。</p><p>之前一直百思不得其解，直到某天看了@跳跳爸的Abc公众号的 <a href="https://mp.weixin.qq.com/s/NngpCYqPeTqXfslWC4opOQ" rel="external nofollow noopener noreferrer" target="_blank">中小规模搜索引擎（ElasticSearch）典型应用场景及性能优化（三）</a>才恍然大悟：</p><blockquote><p>索引配置比较灵活，粒度也比较细，当我们查询索引时其实都是查询某个时间的一个快照数据，只有index searcher重载一次索引文件，这期间（两次reopen index searcher之间）对索引进行的操作才会可见，这段时间也叫做刷新时间（refresh_interval）</p><p>需要注意的是重载索引文件（reopen index searcher）的开销很大，所以一般搜索引擎都是提供近实时的查询服务，以减少重载索引文件的次数，降低系统负载，有个案例：曾经将一个索引的刷新时间从1s调整到5s，整个搜索响应时间从200ms降低到20ms以内，效果可见一斑。</p></blockquote><p><strong><em>高于100ms的请求应该是在es刷新时处理的，所以导致rt高。想象一下，每秒都要对1100w的索引重新刷新，这得多消耗性能。</em></strong></p><p>于是，尝试修改了该索引的refresh_interval为30s（商品搜索实时性没那么高）</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">put /&#123;index&#125;/_settings</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"index"</span>: &#123;</span><br><span class="line">        <span class="attr">"refresh_interval"</span>: <span class="string">"30s"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果十分明显：</p><p><img src="https://coding.net/u/Thare-Lam/p/blog/git/raw/master/asserts/img/0x02/compare.jpg" alt="compare"></p><p>可以看到，在16:05:30时刻将refresh_interval改成了30s，搜索应用的rt瞬间就下降了。并且可以看到，大概每隔30s会出现一两个请求rt较高的情况，这时候就是es重载了索引文件，导致请求变慢。</p><p>这是调整后的日常rt，效果较之前已经好很多了，基本都在100ms以内</p><p><img src="https://coding.net/u/Thare-Lam/p/blog/git/raw/master/asserts/img/0x02/after.jpg" alt="after"></p><p>不过还需继续努力，争取rt在50ms，并想办法消除refresh时的高rt。</p><p>总结一下：</p><ul><li>ES的查询是近实时的（需要做好至少延迟1S的打算），实时性高的场景不适用；</li><li>对于搜索结果实时性不高的场景（如上），可以适当增加refresh_internal，效果真的可见一斑。</li></ul><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Fri Mar 22 2019 22:10:29 GMT+0800 (China Standard Time) --&gt;&lt;blockquote&gt;&lt;p&gt;接手搜索几个月了，把公司的商品搜索从业务代码剥离成独立应用，再不断调整优化（代码结构），目前暂时趋于
      
    
    </summary>
    
      <category term="Elasticsearch" scheme="https://thare.cn/categories/Elasticsearch/"/>
    
    
      <category term="Elasticsearch" scheme="https://thare.cn/tags/Elasticsearch/"/>
    
      <category term="性能调优" scheme="https://thare.cn/tags/%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/"/>
    
  </entry>
  
  <entry>
    <title>Initialization</title>
    <link href="https://thare.cn/posts/8b7d4dee.html"/>
    <id>https://thare.cn/posts/8b7d4dee.html</id>
    <published>2018-09-27T13:07:52.000Z</published>
    <updated>2018-10-14T16:25:06.799Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Fri Mar 22 2019 22:10:29 GMT+0800 (China Standard Time) --><p>果然是懒癌患者，不过应该还没到晚期，还有得治。</p><p>从大学起到研究生再到工作，中间多次下决心坚持写Blog，但最后往往都不了了之，其中最长坚持到一段时间应该是研究生期间了吧（<a href="https://blog.csdn.net/thare_lam" rel="external nofollow noopener noreferrer" target="_blank">献丑了</a>）。</p><p>当然也是知道对自己有帮助的，因为在写的过程中会总结思考，争取把技术和过程尽可能清楚地描述出来，这也是对自己做过和看过的一种总结。常言道，温故而知新。</p><p>所以，今天打算重新拾起，打算利用写Blog这个过程好好总结工作中遇到的问题，并把这些记录下来，给未来的自己留个纪念，同时也希望能够帮助到其他人。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Fri Mar 22 2019 22:10:29 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;果然是懒癌患者，不过应该还没到晚期，还有得治。&lt;/p&gt;&lt;p&gt;从大学起到研究生再到工作，中间多次下决心坚持写Blog，但最后往
      
    
    </summary>
    
      <category term="随笔" scheme="https://thare.cn/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
      <category term="随笔" scheme="https://thare.cn/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
</feed>
